name: Build Docker Images
on:
  push:
    branches: ['main']
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'marketing/**'
      - 'keycloak/**'
      - '.github/workflows/**'

permissions:
  contents: read
  id-token: write

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      marketing: ${{ steps.filter.outputs.marketing }}
      keycloak: ${{ steps.filter.outputs.keycloak }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            marketing:
              - 'marketing/**'
            keycloak:
              - 'keycloak/**'

  backend:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.backend == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: backend
      image-name: labour-tracker-backend

  frontend:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.frontend == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: frontend
      image-name: labour-tracker-frontend
      build-args: |
        VITE_API_URL=${{ vars.VITE_API_URL }}
        VITE_KEYCLOAK_AUTHORITY=${{ vars.VITE_KEYCLOAK_AUTHORITY }}
        VITE_KEYCLOAK_CLIENT_ID=${{ vars.VITE_KEYCLOAK_CLIENT_ID }}
        VITE_KEYCLOAK_METADATA_URL=${{ vars.VITE_KEYCLOAK_METADATA_URL }}
        VITE_POST_LOGOUT_REDIRECT=${{ vars.VITE_POST_LOGOUT_REDIRECT }}

  marketing:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.marketing == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: marketing
      image-name: labour-tracker-marketing
      build-args: |
        BACKEND_API_URL=${{ vars.BACKEND_API_URL }}
        INSTAGRAM_URL=${{ vars.INSTAGRAM_URL }}
        FRONTEND_URL=${{ vars.FRONTEND_URL }}

  keycloak:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.keycloak == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: keycloak
      image-name: labour-tracker-keycloak