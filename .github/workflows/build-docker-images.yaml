name: Build Docker Images
on:
  push:
    branches: ['main']
    paths:
      - 'labour_service/**'
      - 'frontend/**'
      - 'marketing/**'
      - 'keycloak/**'
      - 'notification_service/**'
      - 'contact_service/**'
      - '.github/workflows/**'

permissions:
  contents: read
  id-token: write

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      labour_service: ${{ steps.filter.outputs.labour_service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      marketing: ${{ steps.filter.outputs.marketing }}
      keycloak: ${{ steps.filter.outputs.keycloak }}
      notification_service: ${{ steps.filter.outputs.notification_service }}
      contact_service: ${{ steps.filter.outputs.contact_service }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            labour_service:
              - 'labour_service/**'
            frontend:
              - 'frontend/**'
            marketing:
              - 'marketing/**'
            keycloak:
              - 'keycloak/**'
            notification_service:
              - 'notification_service/**'
            contact_service:
              - 'contact_service/**'

  labour_service:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.labour_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: labour_service
      image-name: labour-service-backend
      stage: http

  labour_service_alembic:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.labour_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: labour_service
      image-name: labour-service-backend-alembic
      stage: migrations
    
  notification_service:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.notification_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: notification_service
      image-name: notification-service-backend
      stage: http

  notification_service_alembic:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.notification_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: notification_service
      image-name: notification-service-backend-alembic
      stage: migrations

  contact_service:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.contact_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: contact_service
      image-name: contact-service-backend
      stage: http

  contact_service_alembic:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.contact_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: contact_service
      image-name: contact-service-backend-alembic
      stage: migrations

  frontend:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.frontend == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: frontend
      image-name: labour-tracker-frontend
      build-args: |
        VITE_LABOUR_SERVICE_URL=${{ vars.LABOUR_SERVICE_URL }}
        VITE_CONTACT_SERVICE_URL=${{ vars.CONTACT_SERVICE_URL }}
        VITE_KEYCLOAK_AUTHORITY=${{ vars.VITE_KEYCLOAK_AUTHORITY }}
        VITE_KEYCLOAK_CLIENT_ID=${{ vars.VITE_KEYCLOAK_CLIENT_ID }}
        VITE_KEYCLOAK_METADATA_URL=${{ vars.VITE_KEYCLOAK_METADATA_URL }}
        VITE_POST_LOGOUT_REDIRECT=${{ vars.MARKETING_URL }}

  marketing:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.marketing == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: marketing
      image-name: labour-tracker-marketing
      build-args: |
        NEXT_PUBLIC_CONTACT_SERVICE_URL=${{ vars.CONTACT_SERVICE_URL }}
        NEXT_PUBLIC_INSTAGRAM_URL=${{ vars.INSTAGRAM_URL }}
        NEXT_PUBLIC_FRONTEND_URL=${{ vars.FRONTEND_URL }}

  keycloak:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.keycloak == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: keycloak
      image-name: labour-tracker-keycloak