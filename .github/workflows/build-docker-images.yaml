name: Build Docker Images

on:
  push:
    branches: ['main']
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'marketing/**'
      - 'keycloak/**'
      - '.github/workflows/**'

jobs:
  backend:
    if: github.event_name == 'push' && contains(github.event.changes, 'backend/')
    uses: ./.github/workflows/build-and-push.yml
    with:
      directory: backend
      image-name: labour-tracker-backend

  frontend:
    if: github.event_name == 'push' && contains(github.event.changes, 'frontend/')
    uses: ./.github/workflows/build-and-push.yml
    with:
      directory: frontend
      image-name: labour-tracker-frontend
      build-args: |
        VITE_API_URL=${{ secrets.VITE_API_URL }}
        VITE_KEYCLOAK_AUTHORITY=${{ secrets.VITE_KEYCLOAK_AUTHORITY }}
        VITE_KEYCLOAK_CLIENT_ID=${{ secrets.VITE_KEYCLOAK_CLIENT_ID }}
        VITE_KEYCLOAK_METADATA_URL=${{ secrets.VITE_KEYCLOAK_METADATA_URL }}
        VITE_POST_LOGOUT_REDIRECT=${{ secrets.VITE_POST_LOGOUT_REDIRECT }}

  marketing:
    if: github.event_name == 'push' && contains(github.event.changes, 'marketing/')
    uses: ./.github/workflows/build-and-push.yml
    with:
      directory: marketing
      image-name: labour-tracker-marketing
      build-args: |
        BACKEND_API_URL=${{ vars.BACKEND_API_URL }}
        INSTAGRAM_URL=${{ vars.INSTAGRAM_URL }}

  keycloak:
    if: github.event_name == 'push' && contains(github.event.changes, 'keycloak/')
    uses: ./.github/workflows/build-and-push.yml
    with:
      directory: keycloak
      image-name: labour-tracker-keycloak