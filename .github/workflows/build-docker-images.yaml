name: Build Docker Images
on:
  push:
    branches: ['main']
    paths:
      - 'labour_service/**'
      - 'frontend/**'
      - 'marketing/**'
      - 'keycloak/**'
      - 'notification_service/**'
      - '.github/workflows/**'

permissions:
  contents: read
  id-token: write

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      labour_service: ${{ steps.filter.outputs.labour_service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      marketing: ${{ steps.filter.outputs.marketing }}
      keycloak: ${{ steps.filter.outputs.keycloak }}
      notification_service: ${{ steps.filter.outputs.notification_service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            labour_service:
              - 'labour_service/**'
            frontend:
              - 'frontend/**'
            marketing:
              - 'marketing/**'
            keycloak:
              - 'keycloak/**'
            notification_service:
              - 'notification_service/**'

  labour_service:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.labour_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: labour_service
      image-name: labour-service-backend
    
  notification_service:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.notification_service == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: notification_service
      image-name: notification-service-backend

  frontend:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.frontend == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: frontend
      image-name: labour-tracker-frontend
      build-args: |
        VITE_API_URL=${{ vars.VITE_API_URL }}
        VITE_KEYCLOAK_AUTHORITY=${{ vars.VITE_KEYCLOAK_AUTHORITY }}
        VITE_KEYCLOAK_CLIENT_ID=${{ vars.VITE_KEYCLOAK_CLIENT_ID }}
        VITE_KEYCLOAK_METADATA_URL=${{ vars.VITE_KEYCLOAK_METADATA_URL }}
        VITE_POST_LOGOUT_REDIRECT=${{ vars.VITE_POST_LOGOUT_REDIRECT }}

  marketing:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.marketing == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: marketing
      image-name: labour-tracker-marketing
      build-args: |
        BACKEND_API_URL=${{ vars.BACKEND_API_URL }}
        INSTAGRAM_URL=${{ vars.INSTAGRAM_URL }}
        FRONTEND_URL=${{ vars.FRONTEND_URL }}

  keycloak:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.keycloak == 'true' }}
    uses: ./.github/workflows/build-and-push.yaml
    with:
      directory: keycloak
      image-name: labour-tracker-keycloak